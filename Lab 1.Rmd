---
title: "52414 - lab 1"
author: "52414"
date: "10/5/2023"
output: html_document
---

```{r}
library(tidyverse) # This includes dplyr, stringr, ggplot2, .. 
library(data.table)
library(rworldmap) # world map
library(ggthemes)
library(reshape2) # melt: change data-frame format long/wide
library(e1071) # skewness and kurtosis
library(rvest)
library(corrplot)
library(moments)
library(spatstat.geom)

```

**Solution:** (Fill code, text, plots etc.)

# 1.a. Loading the data via URL connection:

```{r, cache=TRUE}
democracy <- read_html("https://en.wikipedia.org/wiki/Democracy_Index")
all.tables = html_nodes(democracy, "table")  
regions <- as.data.frame(html_table(all.tables[4], fill = TRUE))
countries <- as.data.frame(html_table(all.tables[6], fill = TRUE))
components <- as.data.frame(html_table(all.tables[7], fill = TRUE))
```

# 1.b.

```{r, cache=TRUE}
countries_rate <- as.data.frame(countries)
top_countries <- countries_rate %>% select(Country, X2022) %>% arrange(desc(X2022)) %>% head(5)
bottom_countries <- countries_rate %>% select(Country, X2022) %>% arrange(X2022) %>% head(5)
Average <- rowMeans(countries_rate %>% select(-c(Region,X2022.rank,Country, Regime.type)))
top_countries_avg <- countries_rate %>% mutate(Average) %>% select(Country,Average) %>% arrange(desc(Average)) %>% head(5)
bottom_countries_avg <- countries_rate %>% mutate(Average) %>% select(Country, Average) %>% arrange(Average) %>% head(5)
```

YOUR ANALYSIS HERE:

Top countries in democracy index for 2022:

```{r}
top_countries
```

By 2006 -2022 Average:

```{r}
top_countries_avg
```

Lowest countries in democracy index for 2022:

```{r}
bottom_countries
```

By 2006 -2022 Average:

```{r}
bottom_countries_avg
```

# 2.a.

```{r, cache=TRUE}
p2 <- ggplot(countries)
p2 <- p2 + geom_boxplot(aes(x=Region, y=X2022)) +theme(text = element_text(size = 6))
p3 <- countries %>% select(Country,Region,X2022) %>% filter(Region == "Middle East and North Africa")
p4 <- countries %>% select(Country,Region,X2022) %>% filter(Region == "Western Europe")
out_3 <- boxplot.stats(p3$X2022)$out
out_ind_3 <- which(p3$X2022 %in% c(out_3))
out_4 <- boxplot.stats(p4$X2022)$out
out_ind_4 <- which(p4$X2022 %in% c(out_4))
p3[out_ind_3,]
p4[out_ind_4,]

```


2.b.

```{r, cache=TRUE}
p5 <- ggplot(countries,aes(X2022)) + geom_density(alpha=.2, fill= "#00BFC4") + facet_wrap(~Region)
p6 <- countries %>% 
     group_by(Region) %>%
     summarize(Mean = mean(X2022), Variance = var(X2022), Skewness = skewness(X2022), Kurtosis = kurtosis(X2022))
```

YOUR ANALYSIS HERE

3.a.

```{r, cache=TRUE}
Countries_graphs <- function(df, names){
  colnames <- colnames(df)
  if (sum(is.element(names, df$Region)) > 0) { x <- "Region" }
  else x <- "Country"
  
  y <-melt(df, id.vars = x)
  
  if (x == "Region"){
    print("this is regions")
    y <- y %>% filter(Region %in% names)
    print(y , "after filtering")
    y <- y%>%  mutate(year = as.Date(as.character(ISOdate(as.numeric(gsub('X', '', variable)),12,31)))) %>% 
    filter(! year< "2006-12-31") %>% mutate(val = as.double(value))
    print(y)
    ggplot(y, aes(x = year, y =val)) + geom_line(aes(color = Region)) + labs(title="Democracy", 
         subtitle="Between the years 2006-2022",
         caption="Source: Wikipedia",
         x="Years",
         fill="Entities") 
  }
  else{
    y <- y %>% filter(Country %in% names)
    y <- y%>%  mutate(year = as.Date(as.character(ISOdate(as.numeric(gsub('X', '', variable)),12,31)))) %>% 
    filter(! year< "2006-12-31") %>% mutate(val = as.double(value))
    ggplot(y, aes(x = year, y =val)) + geom_line(aes(color = Country))+ labs(title="Democracy Index", 
         subtitle="Between the years 2006-2022",
         caption="Source: Wikipedia",
         x="Years",
         fill="Entities") }
}
Countries_graphs(regions, c("World", "North America", "Asia and Australasia"))
```

YOUR ANALYSIS HERE

3.b.

```{r, cache=TRUE}
col <- colnames(countries)

max_value <- countries %>% select( colnames(countries)[which(col <= "X2022" & col >= "X2006")]) %>% apply( 1, max)
 min_value <- countries %>% select( colnames(countries)[which(col <= "X2022" & col >= "X2006")]) %>% apply( 1, min)
 
cntr <- countries %>% mutate(change = X2022 - X2006, max_value, min_value)


cntr1 <- cntr %>% filter(change >= 1.5)
clst1 <- cntr1$Country

cntr2 <- cntr %>% filter(change <= -1.5)
clst2 <- cntr2$Country

cntr3 <- cntr %>% filter(change >= 0.75 & change <= 1.5)
clst3 <- cntr3$Country

cntr4 <- cntr %>% filter(change <= -0.75 & change >= -1.5)
clst4 <- cntr4$Country

cntr5 <- cntr %>% mutate(min_ref = X2022 - min_value) %>% filter(change <= -0.75 & min_ref  >= 0.75)
clst5 <- cntr5$Country

cntr6 <- cntr %>% mutate(max_ref = X2022 - max_value) %>% filter(change >= 0.75 & max_ref  <= -0.75)
clst6 <- cntr6$Country

cntr7 <- cntr %>% mutate(Max_min = max_value -min_value) %>% filter(Max_min <= 0.5)
clst7 <- cntr7$Country

Country <- unique(c(clst1, clst2, clst3, clst4, clst5, clst6, clst7))
clst1_7 <- as.data.frame(Country)
cntr8 <- cntr %>% anti_join(clst1_7)
clst8 <- cntr8$Country

Countries_graphs(countries, clst1)
Countries_graphs(countries, clst2)
Countries_graphs(countries, clst3)
Countries_graphs(countries, clst4)
Countries_graphs(countries, clst5)
Countries_graphs(countries, clst6)
Countries_graphs(countries, clst7)
Countries_graphs(countries, clst8)

```

YOUR ANALYSIS HERE

4.  

```{r, cache=TRUE}

index_2006 <- countries$X2006
regime_2006_type <- c('Full democracy','Flawed democracy','Hybrid regime','Authoritarian')


regime_mobility <- countries %>% mutate(regime_2006 = regime_2006_type[(X2006<=10&X2006>=8)+ 2*(X2006 <8 & X2006 >= 6) + 3*(X2006 < 6 & X2006 >=4) +4*(X2006 < 4 & X2006 >=0)])
                  
regime_mobility <- regime_mobility %>% mutate(regime_pairs = paste(Regime.type,regime_2006))
rgm_prb <- matrix(c(1:16),ncol = 4,byrow = TRUE)
colnames(rgm_prb) <- paste(regime_2006_type) #Regime type in 2022
rownames(rgm_prb) <- regime_2006_type #Regime type in 2006
for (i in colnames(rgm_prb)){
  for (j in rownames(rgm_prb)){
    rgm_prb[j,i] <- length(which(regime_mobility$regime_pairs %in% paste(j,i)))/length(which(regime_mobility$Regime.type %in% i))
  }
} 
heatmap(rgm_prb)
```

YOUR ANALYSIS HERE

5.a.

```{r, cache=TRUE}
# Load GDP table
gdp_page <- read_html("https://en.wikipedia.org/wiki/List_of_countries_by_GDP_(PPP)_per_capita")
gdp_tables <- html_nodes(gdp_page, "table")
gdp_df <- as.data.frame(html_table(gdp_tables[2], fill = TRUE))
colnames(gdp_df) <- paste(colnames(gdp_df), "-", gdp_df[1,])
colnames(gdp_df)[1] <- "Country"
gdp_df$Country <- substr(gdp_df$Country, 1, nchar(gdp_df$Country)- 2)

# Load population size table
population_page <- read_html("https://en.wikipedia.org/wiki/List_of_countries_and_dependencies_by_population")
population_table <- html_table(html_nodes(population_page, "table")[[2]])
population_df <- data.frame(population_table)
colnames(population_df) <- population_df[1,]
colnames(population_df)[2] <- "Country"

# Load incarceration rates table
incarceration_page <- read_html("https://en.wikipedia.org/wiki/List_of_countries_by_incarceration_rate")
incarceration_table <- html_table(html_nodes(incarceration_page, "table")[[2]])
incarceration_df <- data.frame(incarceration_table)
colnames(incarceration_df)[1] <- "Country"

# Load area table
area_page <- read_html("https://en.wikipedia.org/wiki/List_of_countries_and_dependencies_by_area")
area_table <- html_table(html_nodes(area_page, "table")[[2]])
area_df <- data.frame(area_table)
colnames(area_df)[2] <- "Country"


# Join tables using country names
joined_table <- countries %>%
  full_join(gdp_df, by = c("Country" = "Country")) %>%
  full_join(population_df, by = c("Country" = "Country")) %>%
  full_join(incarceration_df, by = c("Country" = "Country")) %>%
  full_join(area_df, by = c("Country" = "Country"))

# Display top five rows of the joined table
head(joined_table, 5)
```

YOUR ANALYSIS HERE

5.b.

```{r, cache=TRUE}
# YOUR CODE HERE
```

YOUR ANALYSIS HERE

6.a.

```{r, cache=TRUE}
# YOUR CODE HERE
```

YOUR ANALYSIS HERE

6.b.

```{r, cache=TRUE}
# YOUR CODE HERE
```

YOUR ANALYSIS HERE

6.c.

```{r, cache=TRUE}
# YOUR CODE HERE
```

YOUR ANALYSIS HERE

7

```{r, cache=TRUE}
country_numeric <- apply(list_by_country[,5:19], 2, as.numeric)
country_lst <- data.frame(html_table(all.tables[6]))
country_slim_lst <- data.table(select(country_lst, X2022.rank, Country, X2022))
tmp_heat <-rowMeans(country_numeric[,-1:-4]) 
country_slim_lst <- mutate(.data = country_slim_lst, avg = tmp_heat)
countries_avg_rating = arrange(country_slim_lst, Country)

#we need to replace Eswatini with Swaziland
countries_avg_rating$Country = gsub("Eswatini", "Swaziland", countries_avg_rating$Country)

#again here we need to replace North Macedonia with Macedonia
countries_avg_rating$Country = gsub("North Macedonia", "Macedonia", countries_avg_rating$Country)

#using the join function to join all the tables:
heat_map_dat = joinCountryData2Map(countries_avg_rating, joinCode="NAME", nameJoinColumn="Country", verbose = TRUE)

#the white countrys are those who does not have an index of democracy
mapCountryData(heat_map_dat, nameColumnToPlot = "avg", mapTitle = "Average democracy index by Country", addLegend = TRUE)

#now we will repeat this function to show the differences between 2006 and 2022:

country_lst$Country = gsub("Eswatini", "Swaziland", country_lst$Country)
country_lst$Country = gsub("North Macedonia", "Macedonia", country_lst$Country)
democracy_index = country_lst %>% select(Country, X2022, X2006) %>%
  mutate(Difference = (X2022 - X2006)) %>% arrange(Country)

dimocracymaps_heat = joinCountryData2Map(democracy_index, joinCode="NAME", nameJoinColumn="Country", verbose = TRUE)

mapCountryData(dimocracymaps_heat, nameColumnToPlot = "Difference", mapTitle = "The difference index between 2022 to 2006 of democracy", addLegend = TRUE)

```

YOUR ANALYSIS HERE

8.a.

```{r, cache=TRUE}
components_lst <- data.frame(html_table(all.tables[7]))

#we will change the columns names by a new vector
colnames(components_lst) <- c("Rank", "chage_in_rank", "Country",  "Regime_type", "Overall_score", "chage_in_score", "Electoral_process_and_pluralism", "Functioning_of_government", "Political_participation", "Political_culture", "Civil_liberties")

# Removing all the "Na" cells
components_lst <- components_lst[complete.cases(components_lst), ]

#Using the Union for all columns, as numeric
components_lst_numeric <- c("Electoral_process_and_pluralism", "Functioning_of_government", "Political_participation", "Political_culture", "Civil_liberties")

# Using the as.numeric function to verify its all numeric
components_lst[, components_lst_numeric] <- sapply(components_lst[, components_lst_numeric], as.numeric)


#Using the merge function to merge all the columns
country_lst <- merge(country_lst, components_lst, by = "Country", x.all = FALSE)


#Display the top 5 rows:
head(components_lst, 5)

```

YOUR ANALYSIS HERE

8.b.

```{r, cache=TRUE}
# YOUR CODE HERE
```

YOUR ANALYSIS HERE
